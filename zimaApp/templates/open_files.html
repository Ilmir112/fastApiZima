<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Просмотр изображений</title>
    <style>
        :root {
            --bg: #111;
            --fg: #eee;
            --accent: #2fa4ff
        }

        html, body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--fg);
            font-family: Inter, system-ui, Segoe UI, Roboto, Arial
        }

        .wrap {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            box-sizing: border-box
        }

        .viewer {
            position: relative;
            width: 100%;
            max-width: 1100px;
            height: 75vh;
            max-height: 900px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            overflow: hidden
        }

        #video {
            max-width: 100%;
            max-height: 100%;
            display: block;
            object-fit: contain;
        }

        img {
            max-width: 100%;
            max-height: 100%;
            display: block;
            object-fit: contain;
            user-select: none
        }

        .controls {
            display: flex;
            gap: 8px;
            align-items: center
        }

        button {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: var(--fg);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer
        }

        button.primary {
            background: var(--accent);
            border-color: transparent;
            color: #000
        }

        .info {
            width: 100%;
            max-width: 1100px;
            color: #bbb;
            text-align: center;
            font-size: 13px
        }

        .nav-hit {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 45%;
            z-index: 10
        }

        .nav-left {
            left: 0
        }

        .nav-right {
            right: 0
        }

        .broken {
            filter: grayscale(60%) opacity(0.6)
        }

        .spinner {
            position: absolute;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.08);
            border-top-color: var(--accent);
            animation: spin 1s linear infinite;
            z-index: 20
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .caption {
            font-size: 13px;
            color: #ddd;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap
        }

        a.link {
            color: var(--accent);
            text-decoration: none
        }
    </style>
</head>
<body>
<div class="wrap">
    <div class="viewer" id="viewer">
        <div class="spinner" id="spinner" style="display:none"></div>
        <div class="nav-hit nav-left" id="hitLeft"></div>
        <div class="nav-hit nav-right" id="hitRight"></div>
        <!-- Для изображений -->
        <img id="img" alt="image viewer" draggable="false"/>
        <!-- Для видео -->
        <video id="video" style="display:none" controls></video>
    </div>

    <div class="controls">
        <button id="prevBtn">&larr; Назад</button>
        <button id="nextBtn" class="primary">Вперед &rarr;</button>
        <button id="fsBtn">Полный экран</button>
        <a id="downloadLink" class="link" href="#" download>Скачать</a>
    </div>

    <div class="info">
        <div class="caption" id="caption">Загрузка...</div>
    </div>
</div>

<script>
    // Получение списка файлов из переменной Python
    const files = {{files | tojson}}
    ;

    // Объявляем переменную images один раз
    let images = [];
    let index = 0;

    // Обработка входных данных
    if (Array.isArray(files)) {
        images = files;
    } else if (typeof files === 'string') {
        // Если это строка, делаем массив из одного элемента
        images = [files];
    } else {
        // Если ничего нет или формат другой
        images = [];
    }

    // Получение элементов DOM
    const img = document.getElementById('img');
    const video = document.getElementById('video');
    const caption = document.getElementById('caption');
    const spinner = document.getElementById('spinner');
    const downloadLink = document.getElementById('downloadLink');

    const hitLeft = document.getElementById('hitLeft');
    const hitRight = document.getElementById('hitRight');
    const fsBtn = document.getElementById('fsBtn');

    // Функция определения типа файла
    function isVideoFile(filename) {
        const videoExtensions = ['mp4', 'webm', 'ogg'];
        const ext = filename.split('.').pop().toLowerCase();
        return videoExtensions.includes(ext);
    }

    function showSpinner(on) {
        spinner.style.display = on ? 'block' : 'none';
    }

    function updateCaption() {
        if (images.length === 0) {
            caption.textContent = 'Нет изображений';
            return;
        }
        const path = images[index];
        caption.textContent = `${index + 1} / ${images.length} — ${path}`;

        // Обновляем ссылку для скачивания
        downloadLink.href = path;
        downloadLink.download = path.split('/').pop();

        if (isVideoFile(path)) {
                // Показываем видео
                img.style.display = 'none';
                video.style.display = 'block';

                // Остановить предыдущее видео
                if (!video.paused) {
                    video.pause();
                }

                // Загружаем новое видео
                video.src = path;
                video.load();

                // Попытка автоматического воспроизведения
                video.play().catch(e => {
                    console.error('Ошибка воспроизведения видео:', e);
                });


            // Можно добавить событие завершения воспроизведения, если нужно:
            // видео можно автоматически запускать при необходимости:
            video.play();

        } else {
            // Показываем изображение
            img.style.display = 'block';
            video.style.display = 'none';

            img.src = path;
            img.onload = () => {
                showSpinner(false);
                updateCaption();
            };
            img.onerror = () => {
                showSpinner(false);
                caption.textContent = 'Ошибка загрузки изображения';
            };
        }
    }

    // Функция переключения изображений/видео
    function showImage(i) {
        if (images.length === 0) return;
        index = (i + images.length) % images.length;
        showSpinner(true);
        updateCaption();
    }

    // Обработчики кнопок навигации
    document.getElementById('prevBtn').onclick = () => showImage(index - 1);
    document.getElementById('nextBtn').onclick = () => showImage(index + 1);

    // Полный экран для всей области просмотра
    fsBtn.onclick = () => {
        if (!document.fullscreenElement) {
            document.querySelector('.viewer').requestFullscreen();
        } else {
            document.exitFullscreen();
        }
    };

    // Навигация по области кликом
    hitLeft.onclick = () => showImage(index - 1);
    hitRight.onclick = () => showImage(index + 1);

    // Инициализация первого элемента при загрузке страницы
    if (images.length > 0) {
        showImage(0);
    } else {
        caption.textContent = 'Нет изображений';
    }
</script>